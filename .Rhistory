## doing og model with remaining data
model1 <- lm(sqrtgr ~ logground, gr_total)
summary(model1)
gr_total$residual <- residuals(model1)
#### models to predict residual
model4 <- lm(residual ~ over10 + above_freeze, gr_total)
summary(model4)
model5 <- lm(residual ~ wind_avg + temp_avg, gr_total)
summary(model5)
model6 <- lm(residual ~ over10 + temp_avg, gr_total)
summary(model6)
model7 <- lm(residual ~ wind_avg + above_freeze, gr_total)
summary(model7)
resid_data <- gr_total[,c(10, 12, 19:21, 23:25, 28:30, 32, 34:35)]
resid_no_na <- na.omit(resid_data)
resid_all <- lm(residual ~ ., resid_no_na)
resid_int <- lm(residual ~ 1, resid_no_na)
resid_forward <- step(resid_int, direction='both', scope=formula(resid_all),
trace=0)
resid_backward <- step(resid_all, direction='both', scope=formula(resid_all),
trace=0)
summary(resid_backward)
summary(resid_forward)
colnames(gr_total)
## looking at tree for potential interactions
library(rpart)
library(rpart.plot)
tree <- rpart(formula = residual ~ roofflat + Exposure + over10 + lat +
Size + Heated, data = resid_no_na)
prp(tree)
gr_vars <- gr_total[,c(7,8,30,23,32,28,20,24)]
pairs(gr_vars)
par(mfrow = c(2, 2))
plot(gr_vars$sqrtgr,(gr_vars$over10))
plot(gr_vars$sqrtgr,log(gr_vars$over10))
plot(gr_vars$sqrtgr,sqrt(gr_vars$over10))
plot(gr_vars$sqrtgr,(gr_vars$over10)^2)
### looking at size
par(mfrow = c(2, 2))
plot(gr_vars$sqrtgr,(gr_vars$Size))
plot(gr_vars$sqrtgr,log(gr_vars$Size))
plot(gr_vars$sqrtgr,sqrt(gr_vars$Size))
plot(gr_vars$sqrtgr,(gr_vars$Size)^2)
## looking at lat
par(mfrow = c(2, 2))
plot(gr_vars$sqrtgr,(gr_vars$lat))
plot(gr_vars$sqrtgr,log(gr_vars$lat))
plot(gr_vars$sqrtgr,sqrt(gr_vars$lat))
plot(gr_vars$sqrtgr,(gr_vars$lat)^2)
## model with varibales suggested by forward regression
model8 <- lm(sqrtgr ~ logground + roofflat + Exposure + log(over10) +
lat + log(Size) + Heated, gr_total)
summary(model8)
## transforming those varaibles and retrying step procedures
resid_transform <- resid_no_na
resid_transform$over10 <- log(resid_transform$over10)
resid_transform$Size <- log(resid_transform$Size)
####### retrying step
resid_all2 <- lm(residual ~ ., resid_transform)
resid_int2 <- lm(residual ~ 1, resid_transform)
resid_forward2 <- step(resid_int2, direction='both', scope=formula(resid_all2),
trace=0)
resid_backward2 <- step(resid_all2, direction='both', scope=formula(resid_all2),
trace=0)
summary(resid_backward2)
summary(resid_forward2)
par(mfrow = c(1, 1))
plot(fitted(resid_forward2), resid(resid_forward2))
qqnorm(resid(resid_forward2), pch = 1, frame = FALSE)
qqline(resid(resid_forward2), col = "steelblue", lwd = 2)
tree2 <- rpart(formula = residual ~ roofflat + Exposure + over10 + lat,
data = resid_transform)
prp(tree2)
## checking new suggested model
model9 <- lm(sqrtgr ~ logground + roofflat + Exposure + log(over10) + lat,
data = gr_total)
summary(model9)
plot(fitted(model9), resid(model9))
qqnorm(resid(model9), pch = 1, frame = FALSE)
qqline(resid(model9), col = "steelblue", lwd = 2)
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
### looks ok other than a few outlier points
summary(model9)
install.packages("onewaytest")
install.packages("onewaytests")
par(mfrow = c(1, 1))
iplot(fitted(model9), resid(model9))
qqnorm(resid(model9), pch = 1, frame = FALSE)
qqline(resid(model9), col = "steelblue", lwd = 2)
plot(fitted(model9), resid(model9))
library(onewaytests)
bf.test(model9)
bf.test(model9, gr_total)
bf.test(sqrtgr ~ logground + roofflat + Exposure + log(over10) + lat,
data = gr_total)
anova(model9)
shapiro.test(resid(model9))
p
shapiro.test(resid(model9))
qqnorm(resid(model9), pch = 1, frame = FALSE)
qqline(resid(model9), col = "steelblue", lwd = 2)
install.packages("olsrr")
### looks ok other than a few outlier points
library(olsrr)
ols_plot_resid_lev(model9)
ols_plot_cooksd_bar(model9)
ols_plot_resid_lev(model9)
qqnorm(resid(model9), pch = 1, frame = FALSE)
qqline(resid(model9), col = "steelblue", lwd = 2)
ols_plot_cooksd_bar(model9)
ols_plot_resid_lev(model9)
ols_plot_cooksd_bar(model9)
ols_plot_cooksd_chart(model9)
ols_plot_resid_lev(model9)
View(gr_total)
ols_plot_resid_stand(model9)
ols_plot_cooksd_chart(model9)
ols_plot_resid_lev(model9)
ols_plot_resid_pot(model9)
ols_plot_resid_pot(model9)
ols_plot_resid_pot(model9)
ols_plot_cooksd_chart(model9)
ols_plot_resid_stand(model9)
ols_plot_resid_lev(model9)
gr_total_no_out <- gr_total[-c(105, 158, 304, 300, 302)]
gr_total_no_out <- gr_total[-c(105, 158, 304, 300, 302),]
model10 <- lm(sqrtgr ~ logground + roofflat + Exposure + log(over10) + lat,
data = gr_total_no_out)
summary(model10)
plot(fitted(model10), resid(model10))
plot(fitted(model9), resid(model9))
plot(fitted(model10), resid(model10))
qqnorm(resid(model10), pch = 1, frame = FALSE)
qqline(resid(model10), col = "steelblue", lwd = 2)
shapiro.test(resid(model10))
plot(fitted(model9), resid(model9), labes = 1:length(resid(model9)))
plot(fitted(model9), resid(model9), labels = 1:length(resid(model9)))
plot(fitted(model9), resid(model9))
text(seq_along(length(resid(model9))))
qqnorm(resid(model9), pch = 1, frame = FALSE)
qqline(resid(model9), col = "steelblue", lwd = 2)
resid(model9)
head(sorted(resid(model9)))
head(sort(resid(model9)))
head(sort(resid(model9), desc = T))
head(sort(resid(model9), dec = T))
qqnorm(resid(model9), pch = 1, frame = FALSE)
qqline(resid(model9), col = "steelblue", lwd = 2)
plot(fitted(model9), resid(model9))
gr_total_no_out <- gr_total[-(abs(resid(model9)) > 0.5),]
model10 <- lm(sqrtgr ~ logground + roofflat + Exposure + log(over10) + lat,
data = gr_total_no_out)
summary(model10)
plot(fitted(model10), resid(model10))
qqnorm(resid(model10), pch = 1, frame = FALSE)
qqline(resid(model10), col = "steelblue", lwd = 2)
nrow(gr_total)
nrow(gr_total_no_out)
head(sort(resid(model9)))
head(sort(resid(model9), decending = TRUE))
head(sort(resid(model9),TRUE))
## removing big outliers
gr_total_no_out <- gr_total[-c(134, 187, 196, 360),]
model10 <- lm(sqrtgr ~ logground + roofflat + Exposure + log(over10) + lat,
data = gr_total_no_out)
summary(model10)
plot(fitted(model10), resid(model10))
qqnorm(resid(model10), pch = 1, frame = FALSE)
qqline(resid(model10), col = "steelblue", lwd = 2)
shapiro.test(resid(model10))
qqnorm(resid(model9), pch = 1, frame = FALSE)
qqline(resid(model9), col = "steelblue", lwd = 2)
plot(fitted(model9), resid(model9))
plot(fitted(model10), resid(model10))
data <- read.csv("C:\\Users\\bean_student\\Documents\\GraphData\\complete_data.csv")
data <- read.csv("C:\\Users\\bean_student\\Documents\\GraphData\\complete_data.csv")
metadata <- read.csv("C:\\Users\\bean_student\\Documents\\GraphData\\gr_meta_ca_all.csv")
data$season <- rep(NA, nrow(data))
data$date <- as.Date(data$date)
data$season <- ifelse((data$date > as.Date("1957-07-01") &
data$date < as.Date("1958-07-01")), 2, data$season)
data$season <- ifelse((data$date > as.Date("1958-07-01") &
data$date < as.Date("1959-07-01")), 3, data$season)
data$season <- ifelse((data$date > as.Date("1959-07-01") &
data$date < as.Date("1960-07-01")), 4, data$season)
data$season <- ifelse((data$date > as.Date("1960-07-01") &
data$date < as.Date("1961-07-01")), 5, data$season)
data$season <- ifelse((data$date > as.Date("1961-07-01") &
data$date < as.Date("1962-07-01")), 6, data$season)
data$season <- ifelse((data$date > as.Date("1962-07-01") &
data$date < as.Date("1963-07-01")), 7, data$season)
data$season <- ifelse((data$date > as.Date("1963-07-01") &
data$date < as.Date("1964-07-01")), 8, data$season)
data$season <- ifelse((data$date > as.Date("1964-07-01") &
data$date < as.Date("1965-07-01")), 9, data$season)
data$season <- ifelse((data$date > as.Date("1965-07-01") &
data$date < as.Date("1966-07-01")), 10, data$season)
data$season <- ifelse((data$date > as.Date("1966-07-01") &
data$date < as.Date("1967-07-01")), 11, data$season)
################# summarise by building code and season #####################
library(dplyr)
ground_max <- data %>%
group_by(building_code, city_code, season) %>%
filter(measurement == "ground") %>%
summarise(ground_max = max(value))
roof_max <- data %>%
group_by(building_code, city_code, season) %>%
filter(mma == "avg") %>%
summarise(roof_max = max(value))
gr_data <- inner_join(ground_max, roof_max, by = c("building_code", "city_code",
"season"))
gr_data$gr <- gr_data$roof_max / gr_data$ground_max
### filtering out the arch hangars
arch_hangars <- c("clab02", "cxbc02", "nbon02", "oton07", "wnmb04")
gr_data2 <- gr_data %>%
filter(!(building_code %in% arch_hangars))
nrow(gr_data)
nrow(gr_data2)
### reporducing linear model
gr_data2$sqrtgr <- sqrt(gr_data2$gr)
gr_data2$logground <- log(gr_data2$ground_max)
model <- lm(sqrtgr ~ logground, data = gr_data2)
summary(model)
#### getting average wind and temps
wind_avgs <-  data %>%
group_by(city_code, season, measurement) %>%
filter(measurement == "wind") %>%
summarise(wind_avg = mean(value))
temp_avgs <-  data %>%
group_by(city_code, season, measurement) %>%
filter(measurement == "temp") %>%
summarise(temp_avg = mean(value))
nrow(wind_avgs)
nrow(temp_avgs)
gr_data3 <- left_join(gr_data2, wind_avgs, by = c("city_code", "season"))
gr_data_weather <- left_join(gr_data3, temp_avgs, by = c("city_code", "season"))
gr_data_weather$sqrtgr <- sqrt(gr_data_weather$gr)
gr_data_weather$logground <- log(gr_data_weather$ground_max)
model <- lm(sqrtgr ~ logground, data = gr_data_weather)
summary(model)
model2 <- lm(sqrtgr ~ logground + wind_avg + temp_avg, gr_data_weather)
summary(model2)
pairs(gr_data_weather[,c(7,8,10,12)])
gr_all <- inner_join(gr_data_weather, metadata, by = c("building_code", "city_code"))
gr_all$roofflat <- ifelse(gr_all$Roof_Type == "Flat" , 1, 0)
model3 <- lm(sqrtgr ~ logground + wind_avg + temp_avg + roofflat +
Exposure + Heated + Insulated + lat + long, gr_all)
summary(model3)
min(na.omit(gr_all$wind_avg))
################# other ways to do weather ##################################
above_freeze <-  data %>%
group_by(city_code, measurement, season) %>%
filter(measurement == "temp") %>%
summarise(above_freeze = sum(value > 32)/length(value))
### percentage days wind speed is over 10
over10 <-  data %>%
group_by(city_code, measurement, season) %>%
filter(measurement == "wind") %>%
summarise(over10 = sum(value > 10)/length(value))
gr_total <- inner_join(gr_all, over10, by = c("city_code", "season")) %>%
inner_join(above_freeze, by = c("city_code", "season"))
## doing og model with remaining data
model1 <- lm(sqrtgr ~ logground, gr_total)
summary(model1)
gr_total$residual <- residuals(model1)
#### models to predict residual
model4 <- lm(residual ~ over10 + above_freeze, gr_total)
summary(model4)
# adjusted R^2 0.06935
model5 <- lm(residual ~ wind_avg + temp_avg, gr_total)
summary(model5)
# adjusted R^2 0.04645
model6 <- lm(residual ~ over10 + temp_avg, gr_total)
summary(model6)
# adjusted R^2 0.09431
model7 <- lm(residual ~ wind_avg + above_freeze, gr_total)
summary(model7)
# adjusted R^2 0.05321
resid_data <- gr_total[,c(10, 12, 19:21, 23:25, 28:30, 32, 34:35)]
resid_no_na <- na.omit(resid_data)
resid_all <- lm(residual ~ ., resid_no_na)
resid_int <- lm(residual ~ 1, resid_no_na)
resid_forward <- step(resid_int, direction='both', scope=formula(resid_all),
trace=0)
resid_backward <- step(resid_all, direction='both', scope=formula(resid_all),
trace=0)
summary(resid_backward)
summary(resid_forward)
colnames(gr_total)
## looking at tree for potential interactions
library(rpart)
library(rpart.plot)
tree <- rpart(formula = residual ~ roofflat + Exposure + over10 + lat +
Size + Heated, data = resid_no_na)
prp(tree)
## looking at transformations
gr_vars <- gr_total[,c(7,8,30,23,32,28,20,24)]
pairs(gr_vars)
par(mfrow = c(2, 2))
plot(gr_vars$sqrtgr,(gr_vars$over10))
plot(gr_vars$sqrtgr,log(gr_vars$over10))
plot(gr_vars$sqrtgr,sqrt(gr_vars$over10))
plot(gr_vars$sqrtgr,(gr_vars$over10)^2)
## log appears to be the closest to linear.
### looking at size
par(mfrow = c(2, 2))
plot(gr_vars$sqrtgr,(gr_vars$Size))
plot(gr_vars$sqrtgr,log(gr_vars$Size))
plot(gr_vars$sqrtgr,sqrt(gr_vars$Size))
plot(gr_vars$sqrtgr,(gr_vars$Size)^2)
## again log looks best
## looking at lat
par(mfrow = c(2, 2))
plot(gr_vars$sqrtgr,(gr_vars$lat))
plot(gr_vars$sqrtgr,log(gr_vars$lat))
plot(gr_vars$sqrtgr,sqrt(gr_vars$lat))
plot(gr_vars$sqrtgr,(gr_vars$lat)^2)
## these all look the same
## model with varibales suggested by forward regression
model8 <- lm(sqrtgr ~ logground + roofflat + Exposure + log(over10) +
lat + log(Size) + Heated, gr_total)
summary(model8)
## transforming those varaibles and retrying step procedures
resid_transform <- resid_no_na
resid_transform$over10 <- log(resid_transform$over10)
resid_transform$Size <- log(resid_transform$Size)
####### retrying step
resid_all2 <- lm(residual ~ ., resid_transform)
resid_int2 <- lm(residual ~ 1, resid_transform)
resid_forward2 <- step(resid_int2, direction='both', scope=formula(resid_all2),
trace=0)
resid_backward2 <- step(resid_all2, direction='both', scope=formula(resid_all2),
trace=0)
summary(resid_backward2)
summary(resid_forward2)
par(mfrow = c(1, 1))
plot(fitted(resid_forward2), resid(resid_forward2))
qqnorm(resid(resid_forward2), pch = 1, frame = FALSE)
qqline(resid(resid_forward2), col = "steelblue", lwd = 2)
# Size is odd. It looks like the big buildings highly influence the results,
# but then when we take the log of size their influence significantly diminishes
# Looking at tree with new suggestion
tree2 <- rpart(formula = residual ~ roofflat + Exposure + over10 + lat,
data = resid_transform)
prp(tree2)
## checking new suggested model
model9 <- lm(sqrtgr ~ logground + roofflat + Exposure + log(over10) + lat,
data = gr_total)
summary(model9)
plot(fitted(model9), resid(model9))
qqnorm(resid(model9), pch = 1, frame = FALSE)
qqline(resid(model9), col = "steelblue", lwd = 2)
shapiro.test(resid(model9))
### looks ok other than a few outlier points
library(olsrr)
ols_plot_cooksd_chart(model9)
# 105, 302, 304, 158
ols_plot_resid_stand(model9)
# 105, 158, 33`, 324`
ols_plot_resid_lev(model9)
# 105, 158, 300, 302, 304
head(sort(resid(model9)))
head(sort(resid(model9),TRUE))
## removing big outliers
gr_total_no_out <- gr_total[-c(134, 187, 196, 360),]
model10 <- lm(sqrtgr ~ logground + roofflat + Exposure + log(over10) + lat,
data = gr_total_no_out)
summary(model10)
plot(fitted(model10), resid(model10))
qqnorm(resid(model10), pch = 1, frame = FALSE)
qqline(resid(model10), col = "steelblue", lwd = 2)
shapiro.test(resid(model10))
## removing those 4 points seems to have done a lot for normality assumption
# On the very low end, residuals are all positive. Other than that I don't see
# much of a pattern
View(resid_no_na)
### no geography forward and backward
resid_no_geo <- resid_no_na[,-9:-10]
View(resid_no_geo)
resid_forward2 <- step(resid_int2, direction='both', scope=formula(resid_all2),
trace=0)
resid_backward2 <- step(resid_all2, direction='both', scope=formula(resid_all2),
trace=0)
View(resid_transform)
### no geography forward and backward
resid_no_geo <- resid_no_na[,-9:-10]
resid_all3 <- lm(residual ~ ., resid_no_geo)
resid_int3 <- lm(residual ~ 1, resid_no_geo)
resid_forward3 <- step(resid_int3, direction='both', scope=formula(resid_all3),
trace=0)
resid_backward3 <- step(resid_all3, direction='both', scope=formula(resid_all3),
trace=0)
summary(resid_backward3)
summary(resid_forward3)
tree_resid <- rpart(formula = residual ~ roofflat + Exposure + over10 + temp_avg
+ Size + Heated, data = resid_no_na)
prp(tree_resid)
resid_all3 <- lm(residual ~ . + roofflat*Exposure, resid_no_geo)
summary(resid_all3)
resid_all3 <- lm(residual ~ . + roofflat*Exposure, resid_no_geo)
resid_int3 <- lm(residual ~ 1, resid_no_geo)
resid_forward3 <- step(resid_int3, direction='both', scope=formula(resid_all3),
trace=0)
resid_backward3 <- step(resid_all3, direction='both', scope=formula(resid_all3),
trace=0)
summary(resid_backward3)
summary(resid_forward3)
resid_all3 <- lm(residual ~ . + roofflat*Exposure + roofflat*slope, resid_no_geo)
resid_int3 <- lm(residual ~ 1, resid_no_geo)
resid_forward3 <- step(resid_int3, direction='both', scope=formula(resid_all3),
trace=0)
resid_backward3 <- step(resid_all3, direction='both', scope=formula(resid_all3),
trace=0)
summary(resid_backward3)
summary(resid_forward3)
nrow(resid_no_geo)
library(glmnet)
View(resid_no_geo)
cv_model <- cv.glmnet(resid_no_geo$residual,
data.matrix(resid_no_geo[,1:11]), alpha = 1)
cv_model <- cv.glmnet(resid_no_geo$residual,
data.matrix(resid_no_geo[,-12]), alpha = 1)
x <- resid_no_geo$residual
y <- data.matrix(resid_no_geo[,-12])
cv_model <- cv.glmnet(x, y, alpha = 1)
y <- data.matrix(resid_no_geo[,colnames(resid_no_geo)[1:11]])
cv_model <- cv.glmnet(x, y, alpha = 1)
View(y)
View(x)
y <- resid_no_geo$residual
y <- resid_no_geo$residual
x <- data.matrix(resid_no_geo[,colnames(resid_no_geo)[1:11]])
y <- resid_no_geo$residual
x <- data.matrix(resid_no_geo[,colnames(resid_no_geo)[1:11]])
cv_model <- cv.glmnet(x, y, alpha = 1)
best_lambda <- cv_model$lambda.min
best_lambda
plot(cv_model)
best_model <- glmnet(x, y, alpha = 1, lambda = best_lambda)
coef(best_model)
plot(gr_total$gr,gr_total$Heated)
median(gr_total$gr[gr_total$Heated == 1])
median(na.omit(gr_total$gr[gr_total$Heated == 1]))
median(na.omit(gr_total$gr[gr_total$Heated == 0]))
cor(gr_total$gr,gr_total$Heated)
cor(gr_total$gr,gr_total$Heated)
plot(resid_no_geo$gr,resid_no_geo$Heated)
plot(resid_no_geo$residual,resid_no_geo$Heated)
median(resid_no_geo$residual[resid_no_geo$Heated == 1])
median(resid_no_geo$residual[resid_no_geo$Heated == 0])
### looking at potentional transformations for temp
par(mfrow = c(2, 2))
plot(gr_vars$sqrtgr,(gr_vars$temp_avg))
plot(gr_vars$sqrtgr,log(gr_vars$temp_avg))
plot(gr_vars$sqrtgr,sqrt(gr_vars$temp_avg))
plot(gr_vars$sqrtgr,(gr_vars$temp_avg)^2)
### looking at potentional transformations for temp
par(mfrow = c(2, 2))
plot(gr_total$sqrtgr,(gr_total$temp_avg))
plot(gr_total$sqrtgr,log(gr_total$temp_avg))
plot(gr_total$sqrtgr,sqrt(gr_total$temp_avg))
plot(gr_total$sqrtgr,(gr_total$temp_avg)^2)
model11 <- lm(sqrtgr ~ logground + roofflat:Exposure + log(over10) + lat +
log(Size) + temp_avg,
data = gr_total)
summary(model11)
par(mfrow = c(1, 1))
model11 <- lm(sqrtgr ~ logground + roofflat:Exposure + log(over10) +
log(Size) + temp_avg + Heated + Insulated,
data = gr_total)
summary(model11)
model11 <- lm(sqrtgr ~ logground + roofflat:Exposure + log(over10) +
log(Size) + temp_avg + Heated + Insulated + lat,
data = gr_total)
summary(model11)
plot(fitted(model11), resid(model11))
summary(model9)
model11 <- lm(sqrtgr ~ logground + roofflat*Exposure + log(over10) +
log(Size) + temp_avg + Heated + Insulated + lat,
data = gr_total)
summary(model11)
model11 <- lm(sqrtgr ~ logground + roofflat*Exposure + log(over10) +
log(Size) + temp_avg + Heated + Insulated,
data = gr_total)
summary(model11)
plot(fitted(model11), resid(model11))
qqnorm(resid(model11), pch = 1, frame = FALSE)
qqline(resid(model11), col = "steelblue", lwd = 2)
shapiro.test(resid(model11))
